<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAC Nagpur Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        iosbg: 'var(--bg)', ioscard: 'var(--card)', iostext: 'var(--text)', 
                        iossub: 'var(--sub)', iosblue: '#0a84ff', iosgreen: '#30d158', 
                        iosred: '#ff453a', iosyellow: '#ffcc00'
                    },
                    animation: { 'pulse-slow': 'pulse 3s infinite', 'slide-up': 'slideUp 0.3s ease-out', 'zoom-in': 'zoomIn 0.2s ease-out' },
                    keyframes: { 
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        zoomIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        :root { --bg: #f2f2f7; --card: #ffffff; --text: #000000; --sub: #8e8e93; }
        .dark { --bg: #000000; --card: #1c1c1e; --text: #f2f2f7; --sub: #8e8e93; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: var(--card); border: 1px solid rgba(128,128,128,0.1); box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 24px; transition: all 0.3s; }
        .dark .glass-panel { background: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .ios-input { background: rgba(128, 128, 128, 0.12); border: none; border-radius: 12px; color: var(--text); font-size: 16px; transition: 0.2s; }
        .ios-input:focus { background: rgba(128, 128, 128, 0.2); outline: none; }
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 400px; }
        .toast { background: rgba(50, 50, 50, 0.95); color: white; padding: 12px 20px; border-radius: 50px; font-weight: 600; text-align: center; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-size: 14px; animation: slideUp 0.3s ease-out; }
        .segment-control { background: rgba(128,128,128,0.15); border-radius: 9px; padding: 2px; display: flex; }
        .segment-btn { flex: 1; text-align: center; padding: 6px; font-size: 13px; font-weight: 600; border-radius: 7px; color: var(--sub); cursor: pointer; transition: 0.2s; }
        .segment-btn.active { background: var(--card); color: var(--text); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        ::-webkit-scrollbar { width: 0px; }
        .hidden { display: none; }
        #map { height: 250px; width: 100%; border-radius: 16px; z-index: 0; }
    </style>
</head>
<body class="flex justify-center min-h-screen">

    <div id="toast-container"></div>

    <div class="w-full max-w-md p-4 flex flex-col h-screen overflow-hidden relative">
        <button onclick="toggleTheme()" class="absolute top-6 right-6 z-50 p-2 rounded-full bg-gray-200 dark:bg-white/10 text-xl transition shadow-lg active:scale-95">
            <span id="theme-icon">üåô</span>
        </button>

        <div id="auth-screen" class="flex-1 flex flex-col justify-center p-2">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-black tracking-tight mb-2">GAC NAGPUR</h1>
                <p class="text-iossub text-sm font-medium">Ultra-Secure Portal</p>
                <div class="mt-4 bg-iosyellow/10 text-iosyellow text-[10px] font-bold py-2 px-4 rounded-full inline-block border border-iosyellow/20">
                    ‚ö†Ô∏è DO NOT USE INCOGNITO MODE
                </div>
            </div>

            <div class="glass-panel p-1 mb-6 flex">
                <button onclick="toggleAuth('login')" id="tab-login" class="flex-1 py-3 text-sm font-bold rounded-xl bg-gray-200 dark:bg-white/10 transition-all">Login</button>
                <button onclick="toggleAuth('register')" id="tab-register" class="flex-1 py-3 text-sm font-bold rounded-xl text-iossub transition-all">Register</button>
            </div>

            <div id="form-login" class="space-y-4">
                <input type="email" id="l-email" placeholder="Email Address" class="ios-input w-full p-4">
                <input type="password" id="l-password" placeholder="Password" class="ios-input w-full p-4">
                <button onclick="login()" id="loginBtn" class="w-full bg-iosblue hover:bg-blue-600 text-white font-bold p-4 rounded-xl text-lg shadow-lg transition-all active:scale-95">Sign In</button>
            </div>

            <div id="form-register" class="space-y-4 hidden">
                <input type="text" id="r-name" placeholder="Full Name" class="ios-input w-full p-4">
                <div class="flex gap-2">
                    <input type="number" id="r-roll" placeholder="Roll No" class="ios-input w-2/3 p-4">
                    <select id="r-year" class="ios-input w-1/3 p-4 font-bold text-center">
                        <option value="1">1st</option>
                        <option value="2">2nd</option>
                        <option value="3">3rd</option>
                    </select>
                </div>
                <input type="email" id="r-email" placeholder="Email Address" class="ios-input w-full p-4">
                <input type="password" id="r-password" placeholder="Create Password" class="ios-input w-full p-4">
                <button onclick="register()" id="regBtn" class="w-full bg-iosgreen hover:bg-green-600 text-white font-bold p-4 rounded-xl text-lg shadow-lg transition-all active:scale-95">Create Account</button>
            </div>
        </div>

        <div id="admin-dashboard" class="hidden flex-col h-full pt-8">
            <h1 class="text-3xl font-bold mb-4 px-2">Admin Panel</h1>
            
            <div class="glass-panel flex-1 flex flex-col overflow-hidden mb-4">
                <div class="p-3 pb-0">
                    <div class="segment-control mb-3">
                        <div onclick="switchAdminTab('students')" id="ad-seg-students" class="segment-btn active">Students</div>
                        <div onclick="switchAdminTab('geo')" id="ad-seg-geo" class="segment-btn">Geofence</div>
                        <div onclick="switchAdminTab('faculty')" id="ad-seg-faculty" class="segment-btn">Faculty</div>
                    </div>
                </div>

                <div id="ad-tab-students" class="flex-1 flex flex-col min-h-0 p-4 pt-0">
                    <div class="flex gap-2 mb-3 overflow-x-auto">
                        <button onclick="loadStudentList('all')" class="bg-gray-200 dark:bg-white/10 px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap">All</button>
                        <button onclick="loadStudentList('1')" class="bg-gray-200 dark:bg-white/10 px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap">1st</button>
                        <button onclick="loadStudentList('2')" class="bg-gray-200 dark:bg-white/10 px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap">2nd</button>
                        <button onclick="loadStudentList('3')" class="bg-gray-200 dark:bg-white/10 px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap">3rd</button>
                    </div>
                    <div class="flex-1 overflow-y-auto rounded-xl bg-gray-100 dark:bg-black/20">
                        <table class="w-full text-xs text-left">
                            <thead class="sticky top-0 bg-gray-200 dark:bg-[#2c2c2e] text-iossub uppercase font-bold z-10">
                                <tr><th class="p-3">Roll</th><th class="p-3">Name</th><th class="p-3 text-right">Actions</th></tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y divide-gray-300 dark:divide-white/5"></tbody>
                        </table>
                    </div>
                </div>

                <div id="ad-tab-geo" class="hidden flex-1 flex flex-col p-4 overflow-y-auto">
                    <div id="map" class="mb-4 border border-gray-500/20"></div>
                    <div class="flex justify-between text-xs font-bold text-iossub mb-2 uppercase">
                        <span>Radius Control</span>
                        <span id="radius-val">50m</span>
                    </div>
                    <input type="range" id="radius-slider" min="20" max="500" value="50" step="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-6" oninput="updateCircleRadius()">
                    
                    <button onclick="saveGeoConfig()" class="w-full bg-iosblue text-white py-3 rounded-xl font-bold shadow-lg mb-2">Save Configuration</button>
                    <p class="text-[10px] text-center text-iossub">Drag Pin to Center ‚Ä¢ Slider for Range</p>
                </div>

                <div id="ad-tab-faculty" class="hidden flex-1 flex flex-col p-4">
                    <div class="mb-4">
                        <h3 class="text-xs font-bold text-iossub uppercase mb-2">Add New Faculty</h3>
                        <input type="email" id="new-t-email" placeholder="Teacher Email" class="ios-input w-full p-3 mb-2 text-sm">
                        <select id="new-t-dept" class="ios-input w-full p-3 mb-2 text-sm">
                            <option value="">Select Department</option>
                            <option>Rachna Sharira</option><option>Kriya Sharira</option><option>Samhita</option>
                            <option>Dravyaguna</option><option>Rasashastra</option><option>Roga Nidan</option>
                            <option>Swasthavritta</option><option>Agad Tantra</option><option>Kayachikitsa</option>
                            <option>Panchakarma</option><option>Shalya Tantra</option><option>Shalakya Tantra</option>
                        </select>
                        <button onclick="addFaculty()" class="w-full bg-iosgreen text-white py-3 rounded-xl font-bold text-sm">Grant Access</button>
                    </div>
                    <h3 class="text-xs font-bold text-iossub uppercase mb-2">Existing Faculty</h3>
                    <div id="faculty-list" class="flex-1 overflow-y-auto space-y-2"></div>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-4 text-iosred font-bold text-sm mb-4">Sign Out</button>
        </div>

        <div id="student-dashboard" class="hidden flex-col h-full pt-6">
            <div class="flex justify-between items-end mb-6 px-2">
                <div>
                    <p class="text-iossub text-sm font-semibold">Welcome,</p>
                    <h1 class="text-3xl font-bold" id="st-name">Student</h1>
                </div>
            </div>

            <div class="glass-panel p-5 mb-6 flex justify-between items-center">
                <div>
                    <p class="text-xs text-iossub uppercase">Roll No</p>
                    <p class="text-xl font-mono font-bold" id="st-roll">--</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-iossub uppercase">Distance</p>
                    <p class="text-xl font-bold text-iosgreen" id="live-range">...</p>
                </div>
            </div>

            <div class="glass-panel flex-1 flex flex-col overflow-hidden mb-4">
                <div class="p-2 pb-0">
                    <div class="segment-control mb-4">
                        <div onclick="switchStudentTab('active')" id="seg-st-active" class="segment-btn active">Mark Attendance</div>
                        <div onclick="switchStudentTab('history')" id="seg-st-history" class="segment-btn">My History</div>
                    </div>
                </div>
                <div id="st-view-active" class="flex-1 flex flex-col justify-center text-center p-4 relative overflow-hidden">
                    <div id="active-class-ui" class="hidden w-full">
                        <div class="w-16 h-16 bg-iosgreen/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse"><span class="text-2xl">üì°</span></div>
                        <h2 class="text-2xl font-bold mb-1" id="session-subject">...</h2>
                        <p class="text-iosgreen font-semibold text-xs uppercase tracking-wide mb-6">Session Active</p>
                        <input type="tel" id="pin-input" maxlength="4" placeholder="PIN" class="ios-input w-40 p-4 text-center text-3xl font-bold tracking-[0.5em] mx-auto mb-6 focus:border-iosblue border-2 border-transparent">
                        <button onclick="verifyAndMark()" id="markBtn" class="w-full bg-iosblue text-white font-bold py-4 rounded-2xl text-lg shadow-xl transition-transform active:scale-95">Verify Location</button>
                    </div>
                    <div id="done-class-ui" class="hidden w-full animate-zoom-in">
                        <div class="w-20 h-20 bg-iosgreen/10 rounded-full flex items-center justify-center mx-auto mb-4 text-iosgreen border-2 border-iosgreen/20"><span class="text-4xl">‚úÖ</span></div>
                        <h2 class="text-xl font-bold mb-2">Class Attended</h2>
                        <button onclick="checkSession()" class="mt-6 text-iossub text-xs">Refresh</button>
                    </div>
                    <div id="no-class-ui" class="w-full">
                        <div class="w-20 h-20 bg-gray-200 dark:bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl grayscale">üò¥</span></div>
                        <h2 class="text-xl font-bold mb-2">No Active Class</h2>
                        <button onclick="checkSession()" class="mt-4 text-iosblue font-semibold text-sm">Refresh Status</button>
                    </div>
                </div>
                <div id="st-view-history" class="hidden flex-1 overflow-y-auto px-4 pb-4">
                    <div id="st-history-list" class="space-y-2 text-xs">Loading...</div>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-4 text-iosred font-bold text-sm mb-4">Sign Out</button>
        </div>

        <div id="teacher-dashboard" class="hidden flex-col h-full pt-6">
            <div class="flex justify-between items-center mb-6 px-2">
                <div>
                    <h1 class="text-2xl font-bold">Teacher</h1>
                    <p class="text-xs text-iossub" id="t-dept">...</p>
                </div>
            </div>

            <div class="glass-panel p-5 mb-6">
                <div id="create-ui">
                    <div class="flex gap-3 mb-3">
                        <select id="t-year" class="ios-input flex-1 p-3 text-sm" onchange="updateSubs()"><option value="">Year</option><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
                        <select id="t-type" class="ios-input flex-1 p-3 text-sm"><option value="Theory">Theory</option><option value="Practical">Practical</option><option value="Posting">Posting</option></select>
                    </div>
                    <select id="t-sub" class="ios-input w-full p-3 mb-3 text-sm"><option>Select Year First</option></select>
                    <div class="flex gap-3">
                        <select id="t-duration" class="ios-input w-1/3 p-3 text-sm"><option value="1">1m</option><option value="2">2m</option><option value="60">1h</option></select>
                        <button onclick="startClass()" class="flex-1 bg-iosblue text-white font-bold rounded-xl text-sm active:scale-95 transition">Start Session</button>
                    </div>
                </div>
                <div id="active-ui" class="hidden text-center py-2">
                    <p class="text-xs text-iossub font-bold uppercase tracking-widest mb-1">Board PIN</p>
                    <p id="pin-display" class="text-6xl font-black mb-6 tracking-wider font-mono">----</p>
                    <button onclick="endClass()" class="w-full bg-iosred text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">End Session</button>
                </div>
            </div>

            <div class="glass-panel flex-1 flex flex-col overflow-hidden mb-4">
                <div class="p-2 pb-0">
                    <div class="segment-control mb-4">
                        <div onclick="switchTab('records')" id="seg-records" class="segment-btn active">Logs</div>
                        <div onclick="switchTab('analytics')" id="seg-analytics" class="segment-btn">Analytics</div>
                    </div>
                </div>
                
                <div id="view-records" class="flex-1 overflow-y-auto px-4 pb-4">
                    <div id="rec-list" class="space-y-3"></div>
                </div>
                
                <div id="view-analytics" class="hidden flex-1 flex flex-col px-4 pb-4">
                    <div class="h-40 w-full mb-4 relative flex justify-center">
                        <canvas id="defaulterChart"></canvas>
                    </div>
                    
                    <div class="flex gap-2 mb-3">
                        <button onclick="calcAnalytics()" class="ios-input px-3 text-xs flex-1 font-bold">üîÑ Refresh Data</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto rounded-xl bg-gray-100 dark:bg-black/20">
                        <table class="w-full text-[10px] text-left">
                            <thead class="text-iossub font-semibold border-b border-gray-300 dark:border-white/5 sticky top-0 bg-gray-200 dark:bg-[#1c1c1e] z-10">
                                <tr><th class="p-2">Roll</th><th class="p-2">Name</th><th class="p-2 text-right">Th%</th><th class="p-2 text-right">Pr%</th><th class="p-2 text-right">Tot%</th></tr>
                            </thead>
                            <tbody id="analytics-body" class="divide-y divide-gray-300 dark:divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-4 text-iosred font-bold text-sm mb-4">Sign Out</button>
        </div>

        <div id="report-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-end">
            <div class="bg-white dark:bg-[#1c1c1e] w-full h-[85vh] rounded-t-[30px] p-0 flex flex-col animate-slide-up shadow-2xl">
                <div class="p-4 border-b border-gray-200 dark:border-white/10 flex justify-between items-center bg-gray-50 dark:bg-white/5 rounded-t-[30px]">
                    <h3 class="font-bold text-lg ml-2">Attendance List</h3>
                    <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded-full font-bold text-gray-500">‚úï</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <table class="w-full text-sm text-left"><tbody id="modal-body" class="divide-y divide-gray-200 dark:divide-white/5 text-gray-700 dark:text-gray-300"></tbody></table>
                </div>
            </div>
        </div>

        <div id="audit-modal" class="fixed inset-0 bg-black/80 hidden z-[60] flex items-end">
            <div class="bg-white dark:bg-[#1c1c1e] w-full h-[90vh] rounded-t-[30px] p-0 flex flex-col animate-slide-up shadow-2xl">
                <div class="p-6 pb-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-bold" id="audit-name">Student Name</h2>
                            <p class="text-iossub font-mono" id="audit-roll">Roll: --</p>
                        </div>
                        <button onclick="document.getElementById('audit-modal').classList.add('hidden')" class="w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded-full font-bold">‚úï</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="audit-timeline"></div>
            </div>
        </div>

        <div id="image-viewer" class="fixed inset-0 bg-black z-[100] hidden flex items-center justify-center animate-zoom-in">
            <button onclick="document.getElementById('image-viewer').classList.add('hidden')" class="absolute top-6 right-6 text-white text-3xl font-bold bg-white/20 w-10 h-10 rounded-full z-10">&times;</button>
            <img id="full-image" src="" class="max-w-full max-h-full object-contain p-2">
        </div>

    </div>

    <input type="file" id="cam" accept="image/*" capture="user" class="hidden" onchange="uploadPhoto()">
    <canvas id="cvs" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, reauthenticateWithCredential, EmailAuthProvider, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, where, getDocs, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyBnv-g-85KNpSmYG0ZN_tfHLR4DsXpDttc", authDomain: "attendance-gac-ngp.firebaseapp.com", projectId: "attendance-gac-ngp", storageBucket: "attendance-gac-ngp.firebasestorage.app", messagingSenderId: "772470800474", appId: "1:772470800474:web:5bcf5808a57995a8991863" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let userRole="", userName="", userRoll="", teacherDept="";
        let rangeLimit=50, collegeLat=21.126222, collegeLng=79.115222;
        let activeSessId=null, activePin=null, activeSubject="";
        let analyticsData=[], chartInstance=null;
        let mapInstance=null, mapCircle=null, mapMarker=null;

        // --- UTILS ---
        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); };
        if(localStorage.getItem('theme')==='light') document.documentElement.classList.remove('dark');

        window.showToast = (msg, type='info') => {
            const d = document.createElement('div'); d.className = 'toast';
            d.style.background = type==='error'?'#ff453a':(type==='success'?'#30d158':'#3a3a3c');
            d.innerHTML = `<span>${msg}</span>`; document.getElementById('toast-container').appendChild(d);
            setTimeout(() => { d.style.opacity='0'; setTimeout(()=>d.remove(), 300) }, 3000);
        };
        window.viewFullImage = (src) => { document.getElementById('full-image').src = src; document.getElementById('image-viewer').classList.remove('hidden'); };

        // --- DEVICE BINDING LOGIC ---
        function getDeviceId() {
            let did = localStorage.getItem('device_id');
            if(!did) { did = crypto.randomUUID(); localStorage.setItem('device_id', did); }
            return did;
        }

        // --- AUTH ---
        window.toggleAuth = (m) => {
            document.getElementById('form-login').classList.toggle('hidden', m!=='login'); 
            document.getElementById('form-register').classList.toggle('hidden', m!=='register');
            document.getElementById('tab-login').className = m==='login'?"flex-1 py-3 text-sm font-bold rounded-xl bg-gray-200 dark:bg-white/10 transition-all":"flex-1 py-3 text-sm font-bold rounded-xl text-iossub transition-all";
            document.getElementById('tab-register').className = m==='register'?"flex-1 py-3 text-sm font-bold rounded-xl bg-gray-200 dark:bg-white/10 transition-all":"flex-1 py-3 text-sm font-bold rounded-xl text-iossub transition-all";
        };

        window.login = async () => {
            const btn = document.getElementById('loginBtn'); btn.innerText = "Verifying...";
            try {
                const uc = await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-password').value);
                const snap = await getDoc(doc(db, "users", uc.user.uid));
                if(snap.exists()) {
                    const d = snap.data();
                    if(d.banned) throw new Error("Account Banned");
                    
                    // STRICT DEVICE CHECK
                    if(d.role === 'student') {
                        const currentDid = getDeviceId();
                        if(d.registered_device_id && d.registered_device_id !== currentDid) {
                            await signOut(auth);
                            throw new Error("üö´ UNAUTHORIZED DEVICE. Contact Admin.");
                        }
                        if(!d.registered_device_id) {
                            await updateDoc(doc(db, "users", uc.user.uid), { registered_device_id: currentDid });
                        }
                    }
                }
            } catch(e) { showToast(e.message, 'error'); await signOut(auth); btn.innerText = "Sign In"; }
        };

        window.register = async () => {
            const n=document.getElementById('r-name').value, r=document.getElementById('r-roll').value, e=document.getElementById('r-email').value, p=document.getElementById('r-password').value, y=document.getElementById('r-year').value;
            if(!n || !r) return showToast("Details required", 'error');
            try {
                const uc = await createUserWithEmailAndPassword(auth, e, p);
                // Check if email is in faculty list
                const facSnap = await getDoc(doc(db, "faculty_whitelist", e));
                const role = facSnap.exists() ? "teacher" : "student";
                const dept = facSnap.exists() ? facSnap.data().dept : null;

                await setDoc(doc(db, "users", uc.user.uid), { 
                    name: n, roll: r, email: e, role: role, year: y, 
                    department: dept, createdAt: new Date(), registered_device_id: getDeviceId() 
                });
                location.reload();
            } catch(e) { showToast(e.message, 'error'); }
        };
        window.logout = () => signOut(auth).then(() => location.reload());

        // --- STATE LISTENER ---
        onAuthStateChanged(auth, async (u) => {
            if(u) {
                const snap = await getDoc(doc(db, "users", u.uid));
                if(!snap.exists()) return;
                const d = snap.data();
                userRole = d.role; userName = d.name; userRoll = d.roll||""; teacherDept = d.department;
                
                // LOAD CONFIG
                const conf = await getDoc(doc(db, "settings", "config")); 
                if(conf.exists()) { 
                    rangeLimit = conf.data().allowedRange || 50; 
                    collegeLat = conf.data().lat || 21.126222;
                    collegeLng = conf.data().lng || 79.115222;
                }

                document.getElementById('auth-screen').classList.add('hidden');
                
                if(userRole==='student') {
                    document.getElementById('student-dashboard').classList.remove('hidden'); document.getElementById('student-dashboard').classList.add('flex');
                    document.getElementById('st-name').innerText = userName; document.getElementById('st-roll').innerText = userRoll;
                    checkSession(); startGPS();
                } else if(userRole==='teacher') {
                    document.getElementById('teacher-dashboard').classList.remove('hidden'); document.getElementById('teacher-dashboard').classList.add('flex');
                    document.getElementById('t-dept').innerText = teacherDept || "Subject Head";
                    loadRecords(); checkTeacherSession();
                } else { // ADMIN
                    document.getElementById('admin-dashboard').classList.remove('hidden'); document.getElementById('admin-dashboard').classList.add('flex');
                    loadStudentList('all');
                }
            }
        });

        // --- ADMIN: STUDENTS ---
        window.switchAdminTab = (t) => {
            ['students','geo','faculty'].forEach(x => {
                document.getElementById(`ad-tab-${x}`).classList.add('hidden');
                document.getElementById(`ad-seg-${x}`).classList.remove('active');
            });
            document.getElementById(`ad-tab-${t}`).classList.remove('hidden');
            document.getElementById(`ad-seg-${t}`).classList.add('active');
            if(t==='geo') initMap();
            if(t==='faculty') loadFacultyList();
        };

        window.loadStudentList = async (filter) => {
            const listBody = document.getElementById('student-list-body'); listBody.innerHTML = "<tr><td colspan='3' class='p-3 text-center'>Loading...</td></tr>";
            let q = query(collection(db, "users"), where("role", "==", "student"));
            if(filter !== 'all') q = query(collection(db, "users"), where("role", "==", "student"), where("year", "==", filter));
            
            const snap = await getDocs(q); listBody.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                const banBtn = `<button onclick="toggleBan('${d.id}', ${u.banned})" class="px-2 py-1 rounded text-xs font-bold ${u.banned ? 'bg-iosgreen/10 text-iosgreen' : 'bg-iosred/10 text-iosred'}">${u.banned ? 'Unban' : 'Ban'}</button>`;
                const resetBtn = `<button onclick="resetDevice('${d.id}')" class="px-2 py-1 ml-1 rounded text-xs font-bold bg-gray-200 dark:bg-white/10" title="Reset Device ID">üì±</button>`;
                const pwdBtn = `<button onclick="resetPwd('${u.email}')" class="px-2 py-1 ml-1 rounded text-xs font-bold bg-gray-200 dark:bg-white/10" title="Send Reset Email">üîë</button>`;
                
                listBody.innerHTML += `
                <tr class="border-b border-gray-200 dark:border-white/5">
                    <td class="p-3 font-mono">${u.roll}</td><td class="p-3">${u.name}</td>
                    <td class="p-3 text-right">${banBtn}${resetBtn}${pwdBtn}</td>
                </tr>`;
            });
        };

        window.resetDevice = async (uid) => {
            if(!confirm("Unbind student's phone? They can link a new one.")) return;
            await updateDoc(doc(db, "users", uid), { registered_device_id: deleteField() });
            showToast("Device Unbound", 'success');
        };
        window.resetPwd = async (email) => {
            if(!confirm("Send password reset email?")) return;
            try { await sendPasswordResetEmail(auth, email); showToast("Email Sent", 'success'); } 
            catch(e) { showToast(e.message, 'error'); }
        };
        window.toggleBan = async (uid, status) => { await updateDoc(doc(db, "users", uid), { banned: !status }); loadStudentList('all'); };

        // --- ADMIN: GEOFENCE (LEAFLET) ---
        window.initMap = () => {
            if(mapInstance) return;
            setTimeout(() => {
                mapInstance = L.map('map').setView([collegeLat, collegeLng], 17);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                
                // Draggable Marker
                mapMarker = L.marker([collegeLat, collegeLng], {draggable: true}).addTo(mapInstance);
                mapMarker.on('dragend', (e) => {
                    const ll = e.target.getLatLng();
                    collegeLat = ll.lat; collegeLng = ll.lng;
                    mapCircle.setLatLng(ll);
                });

                // Range Circle
                mapCircle = L.circle([collegeLat, collegeLng], {
                    color: '#ff453a', fillColor: '#ff453a', fillOpacity: 0.2, radius: rangeLimit
                }).addTo(mapInstance);
                
                document.getElementById('radius-slider').value = rangeLimit;
                document.getElementById('radius-val').innerText = rangeLimit + "m";
            }, 500);
        };
        window.updateCircleRadius = () => {
            rangeLimit = parseInt(document.getElementById('radius-slider').value);
            document.getElementById('radius-val').innerText = rangeLimit + "m";
            if(mapCircle) mapCircle.setRadius(rangeLimit);
        };
        window.saveGeoConfig = async () => {
            await setDoc(doc(db, "settings", "config"), { allowedRange: rangeLimit, lat: collegeLat, lng: collegeLng }, {merge:true});
            showToast("Geofence Updated", 'success');
        };

        // --- ADMIN: FACULTY ---
        window.loadFacultyList = async () => {
            const list = document.getElementById('faculty-list'); list.innerHTML = "Loading...";
            const q = query(collection(db, "users"), where("role", "==", "teacher"));
            const snap = await getDocs(q); list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                list.innerHTML += `<div class="bg-gray-100 dark:bg-white/5 p-3 rounded-lg flex justify-between items-center"><span class="text-xs font-bold">${u.name}</span><span class="text-[10px] bg-iosblue/10 text-iosblue px-2 py-1 rounded">${u.department}</span></div>`;
            });
        };
        window.addFaculty = async () => {
            const e = document.getElementById('new-t-email').value, d = document.getElementById('new-t-dept').value;
            if(!e || !d) return showToast("Fill all fields", 'error');
            await setDoc(doc(db, "faculty_whitelist", e), { dept: d });
            showToast("Access Granted. Teacher must Register now.", 'success');
        };

        // --- TEACHER: ANALYTICS & CHARTS ---
        window.calcAnalytics = async () => {
            const btn = document.querySelector("button[onclick='calcAnalytics()']"); btn.innerText = "Processing...";
            
            // 1. Fetch Sessions
            const sessQ = query(collection(db, "sessions"), where("tid", "==", auth.currentUser.uid));
            const sessSnap = await getDocs(sessQ);
            const sessions = { Theory: [], Practical: [], Posting: [], All: [] };
            sessSnap.forEach(d => { 
                const s = d.data(); 
                const type = s.sub.split('|')[1]?.trim() || "Theory"; 
                if(sessions[type]) sessions[type].push(d.id); 
                sessions.All.push(d.id); 
            });

            // 2. Fetch Submissions
            const subQ = query(collection(db, "submissions")); 
            const subSnap = await getDocs(subQ);
            
            // 3. Process
            const students = {}; 
            subSnap.forEach(d => {
                const sub = d.data(); 
                if(!students[sub.sid]) students[sub.sid] = { name: sub.name, roll: sub.roll, Theory: 0, Practical: 0, All: 0, uid: sub.sid };
                
                if(sessions.Theory.includes(sub.sessId)) students[sub.sid].Theory++;
                if(sessions.Practical.includes(sub.sessId)) students[sub.sid].Practical++;
                if(sessions.All.includes(sub.sessId)) students[sub.sid].All++;
            });

            analyticsData = Object.values(students);
            window.totalClasses = { Theory: sessions.Theory.length, Practical: sessions.Practical.length, All: sessions.All.length };
            
            renderChart();
            renderAnalyticsTable(null); // Show all
            btn.innerText = "üîÑ Refresh Data";
        };

        window.renderChart = () => {
            const ctx = document.getElementById('defaulterChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            const total = window.totalClasses.All || 1;
            let safe=0, warn=0, crit=0;
            
            analyticsData.forEach(s => {
                const pct = (s.All / total) * 100;
                if(pct >= 75) safe++;
                else if(pct >= 65) warn++;
                else crit++;
            });

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Safe (>75%)', 'Warning (65-75%)', 'Critical (<65%)'],
                    datasets: [{ data: [safe, warn, crit], backgroundColor: ['#30d158', '#ffcc00', '#ff453a'], borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: { legend: { display: false } },
                    onClick: (e, el) => {
                        if(el.length === 0) return renderAnalyticsTable(null);
                        const idx = el[0].index;
                        renderAnalyticsTable(idx === 0 ? 'safe' : (idx === 1 ? 'warn' : 'crit'));
                    }
                }
            });
        };

        window.renderAnalyticsTable = (filterMode) => {
            const tbody = document.getElementById('analytics-body'); tbody.innerHTML = "";
            const totT = window.totalClasses.Theory || 1;
            const totP = window.totalClasses.Practical || 1;
            const totA = window.totalClasses.All || 1;

            let filtered = analyticsData.sort((a,b) => parseInt(a.roll) - parseInt(b.roll));
            
            if(filterMode) {
                filtered = filtered.filter(s => {
                    const pct = (s.All / totA) * 100;
                    if(filterMode === 'safe') return pct >= 75;
                    if(filterMode === 'warn') return pct >= 65 && pct < 75;
                    return pct < 65;
                });
            }

            filtered.forEach(st => {
                const pt = Math.round((st.Theory/totT)*100);
                const pp = Math.round((st.Practical/totP)*100);
                const pa = Math.round((st.All/totA)*100);
                const color = pa < 65 ? "text-iosred" : (pa < 75 ? "text-iosyellow" : "text-iosgreen");

                tbody.innerHTML += `
                <tr class="border-b border-gray-200 dark:border-white/5 cursor-pointer hover:bg-black/5 dark:hover:bg-white/5" onclick="showStudentAudit('${st.uid}')">
                    <td class="p-2 font-mono text-iossub">${st.roll}</td>
                    <td class="p-2 font-medium truncate max-w-[100px]">${st.name}</td>
                    <td class="p-2 text-right">${pt}%</td>
                    <td class="p-2 text-right">${pp}%</td>
                    <td class="p-2 text-right font-bold ${color}">${pa}%</td>
                </tr>`;
            });
        };

        window.showStudentAudit = async (uid) => {
            document.getElementById('audit-modal').classList.remove('hidden');
            document.getElementById('audit-timeline').innerHTML = "Loading history...";
            
            const q = query(collection(db, "submissions"), where("sid", "==", uid), where("sessId", "in", window.analyticsData.length ? await getAllTeacherSessionIds() : []));
            // Note: 'in' query limit is 10. Better to just fetch all subs for this student and filter in memory by teacher's sessions.
            
            // OPTIMIZED: Fetch all logs for this student, filter by teacher locally
            const subQ = query(collection(db, "submissions"), where("sid", "==", uid));
            const subSnap = await getDocs(subQ);
            
            // Get teacher sessions
            const sessQ = query(collection(db, "sessions"), where("tid", "==", auth.currentUser.uid));
            const sessSnap = await getDocs(sessQ);
            const mySessIds = sessSnap.docs.map(d => d.id);

            const timeline = document.getElementById('audit-timeline'); timeline.innerHTML = "";
            let relevantSubs = subSnap.docs.filter(d => mySessIds.includes(d.data().sessId)).map(d => d.data());
            
            const userData = analyticsData.find(s => s.uid === uid);
            document.getElementById('audit-name').innerText = userData?.name || "Student";
            document.getElementById('audit-roll').innerText = "Roll: " + (userData?.roll || "--");

            if(relevantSubs.length === 0) timeline.innerHTML = "<p class='text-center text-iossub mt-4'>No attendance records.</p>";
            
            relevantSubs.sort((a,b) => b.time - a.time).forEach(r => {
                timeline.innerHTML += `
                <div class="flex items-center gap-3 mb-4 bg-gray-50 dark:bg-white/5 p-3 rounded-xl">
                    <img src="${r.photo}" onclick="viewFullImage('${r.photo}')" class="w-12 h-12 rounded-lg object-cover border border-gray-200 dark:border-white/10">
                    <div>
                        <p class="font-bold text-sm">${r.subName}</p>
                        <p class="text-xs text-iossub">${r.time.toDate().toLocaleString()}</p>
                    </div>
                </div>`;
            });
        };
        async function getAllTeacherSessionIds() {
            const q = query(collection(db, "sessions"), where("tid", "==", auth.currentUser.uid));
            const s = await getDocs(q); return s.docs.map(d => d.id);
        }

        // --- COMMON TEACHER FUNCTIONS ---
        const subs = { "1": ["Rachna Sharira", "Kriya Sharira", "Samhita-I", "Padarth Vigyan", "Sanskrit"], "2": ["Agad Tantra", "Swasthavritta", "Dravyaguna", "Rog Nidana", "Samhita-II", "Rasashastra"], "3": ["Kayachikitsa", "Panchakarma", "Shalya Tantra", "Shalakya Tantra", "Prasuti & Stree Roga", "Kaumarabhritya", "Research"] };
        window.updateSubs = () => {
            const y = document.getElementById('t-year').value, s = document.getElementById('t-sub'); s.innerHTML = "";
            let list = subs[y] || [];
            if(teacherDept && teacherDept !== "Admin") list = list.filter(i => i === teacherDept);
            list.forEach(i => s.innerHTML += `<option>${i}</option>`);
        };
        window.startClass = async () => {
            const sub = document.getElementById('t-sub').value, dur = parseInt(document.getElementById('t-duration').value);
            const fullSub = `${sub} | ${document.getElementById('t-type').value}`;
            const ref = await addDoc(collection(db, "sessions"), { tid: auth.currentUser.uid, sub: fullSub, start: new Date(), end: new Date(Date.now() + dur*60000), active: true, pin: Math.floor(1000 + Math.random() * 9000).toString() });
            activeSessId = ref.id; checkTeacherSession();
        };
        window.endClass = async () => { await updateDoc(doc(db, "sessions", activeSessId), { active: false, end: new Date() }); location.reload(); };
        async function checkTeacherSession() {
            const q = query(collection(db, "sessions"), where("tid", "==", auth.currentUser.uid), where("active", "==", true));
            const snap = await getDocs(q);
            snap.forEach(d => { 
                if(d.data().end.toDate() > new Date()) { 
                    activeSessId = d.id; 
                    document.getElementById('create-ui').classList.add('hidden'); 
                    document.getElementById('active-ui').classList.remove('hidden'); 
                    document.getElementById('pin-display').innerText = d.data().pin; 
                } 
            });
        }
        window.loadRecords = async () => {
            const q = query(collection(db, "sessions"), where("tid", "==", auth.currentUser.uid));
            const snap = await getDocs(q);
            const list = document.getElementById('rec-list'); list.innerHTML = "";
            let docs = []; snap.forEach(d => docs.push({id: d.id, ...d.data()}));
            docs.sort((a,b) => b.start.seconds - a.start.seconds);
            docs.forEach(d => {
                list.innerHTML += `<div class="bg-gray-100 dark:bg-white/5 p-4 rounded-xl flex justify-between cursor-pointer" onclick="showReport('${d.id}')"><div><p class="font-bold text-sm">${d.sub}</p><p class="text-xs text-iossub mt-1">${d.start.toDate().toLocaleString()}</p></div><div class="text-iosblue text-xl">‚Ä∫</div></div>`;
            });
        };
        window.showReport = async (sid) => {
            document.getElementById('report-modal').classList.remove('hidden');
            const b = document.getElementById('modal-body'); b.innerHTML = "Loading...";
            const q = query(collection(db, "submissions"), where("sessId", "==", sid));
            const snap = await getDocs(q); b.innerHTML = "";
            snap.forEach(d => { 
                const s = d.data();
                b.innerHTML += `<tr class="border-b border-gray-200 dark:border-white/5"><td class="p-2 font-mono text-iosblue">${s.roll}</td><td class="p-2"><img src="${s.photo}" class="w-10 h-10 rounded-lg object-cover" onclick="viewFullImage('${s.photo}')"></td><td class="p-2 font-bold">${s.name}</td><td class="p-2 text-right text-xs">${s.time.toDate().toLocaleTimeString()}</td></tr>`; 
            });
        };
        window.switchTab = (t) => {
            document.getElementById('view-records').classList.toggle('hidden', t!=='records'); 
            document.getElementById('view-analytics').classList.toggle('hidden', t!=='analytics');
            document.getElementById('seg-records').className = t==='records'?"segment-btn active":"segment-btn"; 
            document.getElementById('seg-analytics').className = t==='analytics'?"segment-btn active":"segment-btn";
        };

        // --- STUDENT GPS ---
        function startGPS() {
            navigator.geolocation.watchPosition(p => {
                const d = getDist(p.coords.latitude, p.coords.longitude);
                document.getElementById('live-range').innerText = Math.round(d) + "m";
                document.getElementById('live-range').className = d < rangeLimit ? "text-xl font-bold text-iosgreen" : "text-xl font-bold text-iosred";
            }, null, {enableHighAccuracy: true});
        }
        window.checkSession = async () => {
            const q = query(collection(db, "sessions"), where("active", "==", true));
            const snap = await getDocs(q);
            let found = false;
            for(const d of snap.docs) {
                if(d.data().end.toDate() > new Date()) {
                    found = true; activeSessId = d.id; activePin = d.data().pin; activeSubject = d.data().sub;
                    // Check previous sub
                    const subQ = query(collection(db, "submissions"), where("sessId", "==", d.id), where("sid", "==", auth.currentUser.uid));
                    const subSnap = await getDocs(subQ);
                    document.getElementById('active-class-ui').classList.toggle('hidden', !subSnap.empty);
                    document.getElementById('done-class-ui').classList.toggle('hidden', subSnap.empty);
                    document.getElementById('no-class-ui').classList.add('hidden');
                    document.getElementById('session-subject').innerText = activeSubject;
                    break;
                }
            }
            if(!found) { document.getElementById('active-class-ui').classList.add('hidden'); document.getElementById('done-class-ui').classList.add('hidden'); document.getElementById('no-class-ui').classList.remove('hidden'); }
        };
        window.verifyAndMark = () => { 
            const btn = document.getElementById('markBtn');
            if(btn.innerText.includes("Selfie")) { document.getElementById('cam').click(); return; }
            if(document.getElementById('pin-input').value !== activePin) return showToast("Wrong PIN", 'error');
            
            btn.innerText = "Checking..."; btn.disabled = true;
            navigator.geolocation.getCurrentPosition(async (p) => { 
                const d = getDist(p.coords.latitude, p.coords.longitude); 
                if(d > rangeLimit) { btn.innerText = "Verify Location"; btn.disabled = false; return showToast(`Too far (${Math.round(d)}m)`, 'error'); }
                btn.innerText = "üì∏ Take Selfie"; btn.style.backgroundColor = "#30d158"; btn.disabled = false; 
            });
        };
        window.uploadPhoto = () => { 
            const f = document.getElementById('cam').files[0]; if(!f) return;
            document.getElementById('markBtn').innerText = "Uploading...";
            const r = new FileReader(); r.readAsDataURL(f); 
            r.onload = (e) => { 
                const img = new Image(); img.src = e.target.result; 
                img.onload = () => { 
                    const c = document.getElementById('cvs'), x = c.getContext('2d'); 
                    const s = 300/img.width; c.width=300; c.height=img.height*s; x.drawImage(img,0,0,300,c.height);
                    submit(c.toDataURL('image/jpeg', 0.5)); 
                }; 
            }; 
        };
        async function submit(b64) { 
            await addDoc(collection(db, "submissions"), { sid: auth.currentUser.uid, name: userName, roll: userRoll, sessId: activeSessId, subName: activeSubject, photo: b64, time: new Date() });
            showToast("Marked!", 'success'); setTimeout(() => location.reload(), 1500); 
        }
        window.switchStudentTab = (t) => { document.getElementById('st-view-active').classList.toggle('hidden', t!=='active'); document.getElementById('st-view-history').classList.toggle('hidden', t!=='history'); document.getElementById('seg-st-active').className = t==='active'?"segment-btn active":"segment-btn"; document.getElementById('seg-st-history').className = t==='history'?"segment-btn active":"segment-btn"; if(t==='history') loadStudentHistory(); };
        window.loadStudentHistory = async () => {
            const list = document.getElementById('st-history-list'); list.innerHTML = "Loading...";
            const q = query(collection(db, "submissions"), where("sid", "==", auth.currentUser.uid));
            const snap = await getDocs(q); list.innerHTML = "";
            snap.forEach(d => { const r = d.data(); list.innerHTML += `<div class="bg-gray-100 dark:bg-white/5 p-3 rounded-lg flex justify-between"><p class="font-bold">${r.subName || 'Class'}</p><p class="text-xs text-iossub">${r.time.toDate().toLocaleDateString()}</p></div>`; });
        };
        function getDist(lat1, lon1) { 
            const R = 6371e3; const œÜ1 = lat1 * Math.PI/180, œÜ2 = collegeLat * Math.PI/180; 
            const ŒîœÜ = (collegeLat-lat1) * Math.PI/180, ŒîŒª = (collegeLng-lon1) * Math.PI/180; 
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2); 
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        }
    </script>
</body>
</html>
