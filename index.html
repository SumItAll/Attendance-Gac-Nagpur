<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAC Attendance Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: sans-serif; background-color: #f3f4f6; }</style>
</head>
<body class="p-4 max-w-lg mx-auto">

    <div id="auth-screen" class="bg-white p-6 rounded-lg shadow-lg mt-10">
        <h2 class="text-3xl font-bold text-center text-green-700 mb-2">üåø GAC Sakkardara</h2>
        <p class="text-center text-gray-500 mb-6">Attendance Portal</p>

        <input type="email" id="email" placeholder="Email" class="w-full p-3 border rounded mb-3">
        <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded mb-4">
        
        <button id="loginBtn" onclick="login()" class="w-full bg-green-600 text-white p-3 rounded font-bold hover:bg-green-700">Login</button>
        <p id="status-msg" class="text-center mt-4 text-sm text-red-500"></p>
    </div>

    <div id="admin-dashboard" class="hidden">
        <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-red-500">
            <h1 class="text-xl font-bold text-red-700">üõ°Ô∏è Admin Panel</h1>
            <p class="text-sm text-gray-500">Welcome, <span id="admin-name">Admin</span></p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="font-bold mb-2">Storage Maintenance</h2>
            <button onclick="cleanOldData()" id="btn-purge" class="w-full bg-red-100 text-red-700 border border-red-200 p-3 rounded font-bold">
                üóëÔ∏è Clean Data (> 45 Days)
            </button>
            <p id="admin-log" class="text-xs mt-3 text-gray-500 font-mono"></p>
        </div>
        <button onclick="logout()" class="mt-6 text-gray-500 w-full text-center">Logout</button>
    </div>

    <div id="student-dashboard" class="hidden">
        <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-green-500">
            <h1 class="text-xl font-bold">üë®‚Äçüéì Student Profile</h1>
            <p class="text-gray-600">Name: <span id="st-name" class="font-bold">...</span></p>
        </div>

        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">Mark Attendance</h2>
            
            <div id="active-session-box" class="p-4 bg-yellow-50 border border-yellow-200 rounded hidden">
                <div class="flex items-center mb-2">
                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse mr-2"></div>
                    <p class="font-bold text-yellow-800">Class In Progress</p>
                </div>
                <p id="session-subject" class="text-lg font-bold mb-1">...</p>
                <button onclick="markAttendance()" id="markBtn" class="w-full bg-blue-600 text-white p-3 rounded font-bold shadow-lg mt-2">üì∏ Mark Present</button>
            </div>

            <div id="no-session-msg" class="text-gray-400 text-center py-8 bg-gray-50 rounded border border-dashed">
                <p>No active classes right now.</p>
                <button onclick="checkForActiveSessions()" class="text-blue-500 text-sm mt-2 underline">Refresh</button>
            </div>
        </div>
        <button onclick="logout()" class="mt-6 text-gray-500 w-full text-center">Logout</button>
    </div>

    <div id="teacher-dashboard" class="hidden">
        <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-blue-500">
            <h1 class="text-xl font-bold text-blue-700">üë©‚Äçüè´ Teacher Panel</h1>
            <p class="text-sm text-gray-500">Manage Classes</p>
        </div>

        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h2 class="font-bold mb-3">‚è±Ô∏è Live Session Control</h2>
            
            <div id="start-controls">
                <label class="block mb-1 font-bold text-sm">Subject</label>
                <select id="t-subject" class="w-full p-3 border rounded mb-3 bg-gray-50">
                    <option>Agadtantra</option>
                    <option>Swasthavritta</option>
                    <option>Samhita-II</option>
                    <option>Rog Nidan</option>
                    <option>Dravyaguna</option>
                </select>
                <select id="t-duration" class="w-full p-3 border rounded mb-4 bg-gray-50">
                    <option value="5">5 Mins</option>
                    <option value="10">10 Mins</option>
                    <option value="60">1 Hour</option>
                </select>
                <button onclick="createSession()" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">Start Class</button>
            </div>

            <div id="cancel-controls" class="hidden">
                <div class="bg-green-100 p-3 rounded border border-green-300 text-green-800 mb-3 text-center">
                    <p class="font-bold">‚úÖ Class is Live!</p>
                    <p class="text-xs">Students can mark attendance now.</p>
                </div>
                <button onclick="cancelSession()" class="w-full bg-red-600 text-white p-3 rounded font-bold hover:bg-red-700 animate-pulse">
                    ‚õî Cancel / End Session
                </button>
            </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="font-bold mb-3">üìÑ Past Attendance Records</h2>
            <button onclick="loadHistory()" class="w-full bg-gray-200 text-gray-700 p-2 rounded text-sm mb-4">üîÑ Load History</button>
            
            <div id="history-list" class="space-y-2"></div> <div id="report-view" class="hidden mt-4">
                <h3 class="font-bold text-sm text-gray-600 border-b pb-2 mb-2" id="report-title">Attendance List</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-2 py-2">Photo</th>
                                <th class="px-2 py-2">Name</th>
                                <th class="px-2 py-2">Time</th>
                            </tr>
                        </thead>
                        <tbody id="report-body"></tbody>
                    </table>
                </div>
                <button onclick="closeReport()" class="mt-3 text-blue-500 text-xs underline">Close Report</button>
            </div>
        </div>

        <button onclick="logout()" class="mt-6 text-gray-500 w-full text-center">Logout</button>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="user" class="hidden" onchange="processPhoto()">
    <canvas id="compressor" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // GLOBAL VARS
        let auth, db, currentUserName = "";
        window.activeSessionId = null;

        // --- PASTE YOUR KEYS HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnv-g-85KNpSmYG0ZN_tfHLR4DsXpDttc",
  authDomain: "attendance-gac-ngp.firebaseapp.com",
  projectId: "attendance-gac-ngp",
  storageBucket: "attendance-gac-ngp.firebasestorage.app",
  messagingSenderId: "772470800474",
  appId: "1:772470800474:web:5bcf5808a57995a8991863"
        };

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error(e); }

        // --- AUTH ---
        window.login = () => {
            const e = document.getElementById("email").value;
            const p = document.getElementById("password").value;
            document.getElementById("loginBtn").innerText = "Checking...";
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                alert(err.message);
                document.getElementById("loginBtn").innerText = "Login";
            });
        };
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    currentUserName = data.name || "Student";
                    document.getElementById("auth-screen").classList.add("hidden");
                    
                    if(data.role === "student") {
                        document.getElementById("student-dashboard").classList.remove("hidden");
                        document.getElementById("st-name").innerText = currentUserName;
                        checkForActiveSessions();
                    } else if (data.role === "teacher") {
                        document.getElementById("teacher-dashboard").classList.remove("hidden");
                    } else if (data.role === "admin") {
                        document.getElementById("admin-dashboard").classList.remove("hidden");
                        document.getElementById("admin-name").innerText = currentUserName;
                    }
                }
            }
        });

        // --- STUDENT LOGIC ---
        window.markAttendance = () => {
             if (navigator.geolocation) {
                const btn = document.getElementById("markBtn");
                btn.innerText = "üìç Locating...";
                navigator.geolocation.getCurrentPosition((pos) => {
                    const collegeLat = 21.126222; 
                    const collegeLng = 79.115222;
                    const d = getDistanceFromLatLonInM(pos.coords.latitude, pos.coords.longitude, collegeLat, collegeLng);
                    
                    if (d < 50) { // 50 METERS RANGE
                        document.getElementById("cameraInput").click();
                        btn.innerText = "üì∏ Open Camera";
                    } else { 
                        alert(`‚ùå You are ${Math.round(d)}m away. Move closer to Dept.`);
                        btn.innerText = "üì∏ Mark Present";
                    }
                }, (err) => { alert("GPS Error: " + err.message); btn.innerText = "Retry"; }, {enableHighAccuracy:true});
            } else { alert("GPS not supported"); }
        };

        window.processPhoto = () => {
            const file = document.getElementById("cameraInput").files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.getElementById("compressor");
                    const ctx = canvas.getContext("2d");
                    const MAX_WIDTH = 300; // Thumbnail size
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    submitToDB(canvas.toDataURL("image/jpeg", 0.5));
                };
            };
        };

        async function submitToDB(photoBase64) {
             await addDoc(collection(db, "submissions"), {
                studentId: auth.currentUser.uid,
                studentName: currentUserName, // Saving Name for Easy Teacher Report
                sessionId: window.activeSessionId,
                photoBase64: photoBase64,
                timestamp: new Date(),
                status: "Present"
            });
            alert("‚úÖ Attendance Marked!");
            location.reload();
        }

        // --- TEACHER LOGIC ---
        window.createSession = async () => {
            const subject = document.getElementById("t-subject").value;
            const duration = parseInt(document.getElementById("t-duration").value);
            const endTime = new Date();
            endTime.setMinutes(endTime.getMinutes() + duration);

            const docRef = await addDoc(collection(db, "sessions"), {
                teacherId: auth.currentUser.uid,
                subject: subject,
                startTime: new Date(),
                endTime: endTime,
                isActive: true
            });
            
            // Switch UI to "Active" mode
            window.currentSessionId = docRef.id;
            document.getElementById("start-controls").classList.add("hidden");
            document.getElementById("cancel-controls").classList.remove("hidden");
        };

        window.cancelSession = async () => {
            if(confirm("Are you sure you want to CANCEL this session?")) {
                if(window.currentSessionId) {
                    await deleteDoc(doc(db, "sessions", window.currentSessionId));
                    alert("üö´ Session Cancelled.");
                    document.getElementById("start-controls").classList.remove("hidden");
                    document.getElementById("cancel-controls").classList.add("hidden");
                }
            }
        };

        // --- TEACHER REPORT LOGIC ---
        window.loadHistory = async () => {
            const list = document.getElementById("history-list");
            list.innerHTML = "Loading...";
            
            // Get last 10 sessions by this teacher
            const q = query(collection(db, "sessions"), where("teacherId", "==", auth.currentUser.uid), orderBy("startTime", "desc")); // Needs Index, but let's try simple first
            
            // Simple query first to avoid Index errors for now
            const qSimple = query(collection(db, "sessions"), where("teacherId", "==", auth.currentUser.uid));
            const snapshot = await getDocs(qSimple);
            
            list.innerHTML = "";
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const timeStr = data.startTime.toDate().toLocaleString();
                
                const btn = document.createElement("button");
                btn.className = "w-full text-left p-3 bg-gray-50 border rounded hover:bg-gray-100 flex justify-between";
                btn.innerHTML = `<span><b>${data.subject}</b><br><span class='text-xs'>${timeStr}</span></span> <span>üëâ</span>`;
                btn.onclick = () => showReport(docSnap.id, data.subject);
                list.appendChild(btn);
            });
            
            if(snapshot.empty) list.innerHTML = "<p class='text-sm text-gray-400'>No past classes found.</p>";
        };

        window.showReport = async (sessionId, subject) => {
            document.getElementById("report-view").classList.remove("hidden");
            document.getElementById("report-title").innerText = `Report: ${subject}`;
            const tbody = document.getElementById("report-body");
            tbody.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";

            const q = query(collection(db, "submissions"), where("sessionId", "==", sessionId));
            const snapshot = await getDocs(q);

            tbody.innerHTML = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                const time = data.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const row = `
                    <tr class="bg-white border-b">
                        <td class="px-2 py-2">
                            <img src="${data.photoBase64}" class="w-10 h-10 rounded-full border border-gray-300 object-cover" onclick="window.open(this.src)">
                        </td>
                        <td class="px-2 py-2 font-medium text-gray-900">${data.studentName || "Student"}</td>
                        <td class="px-2 py-2 text-gray-500">${time}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            if(snapshot.empty) tbody.innerHTML = "<tr><td colspan='3' class='p-4 text-center'>No students present.</td></tr>";
        };

        window.closeReport = () => {
            document.getElementById("report-view").classList.add("hidden");
        };

        // --- SHARED UTILS ---
        window.checkForActiveSessions = async () => {
            const q = query(collection(db, "sessions"), where("isActive", "==", true));
            const snapshot = await getDocs(q);
            let found = false;
            snapshot.forEach((doc) => {
                if (new Date() < doc.data().endTime.toDate()) {
                    document.getElementById("active-session-box").classList.remove("hidden");
                    document.getElementById("no-session-msg").classList.add("hidden");
                    document.getElementById("session-subject").innerText = doc.data().subject;
                    window.activeSessionId = doc.id;
                    found = true;
                }
            });
            if(!found) {
                 document.getElementById("active-session-box").classList.add("hidden");
                 document.getElementById("no-session-msg").classList.remove("hidden");
            }
        };

        window.cleanOldData = async () => {
            document.getElementById("btn-purge").innerText = "Processing...";
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - 45); 
            const q = query(collection(db, "submissions"), where("timestamp", "<", cutoff));
            const snapshot = await getDocs(q);
            snapshot.forEach(async (d) => await deleteDoc(d.ref));
            document.getElementById("btn-purge").innerText = "Done";
        };

        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R = 6371e3; var dLat = (lat2-lat1) * Math.PI/180; var dLon = (lon2-lon1) * Math.PI/180; 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; 
        }
    </script>
</body>
</html>
