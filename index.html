<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAC X-Dark Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // X-style dark mode palette
                        xbase: '#000000',
                        xpanel: '#16181c',
                        xlight: '#eff3f4',
                        xgray: '#71767b',
                        xaccent: '#1d9bf0', // Twitter/X Blue for subtle accents
                    }
                }
            }
        }
    </script>
    <style>
        /* Base Dark Theme */
        body {
            background-color: #000000;
            /* Subtle deep gradient to give the glass something to blur over */
            background-image: radial-gradient(circle at top right, rgba(29, 155, 240, 0.15), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(255, 255, 255, 0.05), transparent 40%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #eff3f4;
        }

        /* Dark Glassmorphism Utility Classes */
        .glass-panel {
            background-color: rgba(22, 24, 28, 0.65); /* Semi-transparent X panel color */
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle light border */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        
        .glass-input {
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
        }
        .glass-input:focus {
            border-color: #1d9bf0; /* X Blue focus */
            background-color: rgba(0, 0, 0, 0.6);
        }

        /* Buttons that pop */
        .btn-primary {
            background-color: #eff3f4; /* High contrast white */
            color: black;
            font-weight: 700;
            transition: all 0.2s;
        }
        .btn-primary:hover { background-color: #d7dbdc; }

        .btn-danger {
            background-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        .btn-danger:hover { background-color: rgba(239, 68, 68, 0.3); }

        .glass-pill {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #eff3f4;
        }
        .glass-pill:hover { background: rgba(255, 255, 255, 0.2); }

        /* Scrollbar styling for dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #16181c; }
        ::-webkit-scrollbar-thumb { background: #333639; rounded: 4px; }

        /* Utilities */
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 flex items-center justify-center text-xlight">

    <div class="w-full max-w-md relative z-10">
        
        <div id="auth-screen" class="glass-panel rounded-3xl p-8 mt-10">
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto flex items-center justify-center text-4xl mb-4">üåø</div>
                <h2 class="text-3xl font-black tracking-tight">GAC Portal</h2>
                <p class="text-xgray text-sm mt-2 font-medium">Sakkardara Attendance System</p>
            </div>

            <div class="space-y-4">
                <input type="email" id="email" placeholder="Email Address" class="glass-input w-full p-4 rounded-xl outline-none transition placeholder-gray-500">
                <input type="password" id="password" placeholder="Password" class="glass-input w-full p-4 rounded-xl outline-none transition placeholder-gray-500">
                
                <button id="loginBtn" onclick="login()" class="w-full btn-primary p-4 rounded-full text-lg shadow-lg mt-6">
                    Log In
                </button>
            </div>
        </div>

        <div id="admin-dashboard" class="hidden glass-panel rounded-3xl p-6">
            <div class="flex items-center justify-between mb-6 border-b border-white/10 pb-4">
                <h1 class="text-xl font-bold text-red-400">üõ°Ô∏è Admin Control</h1>
            </div>
            
            <div class="glass-input p-5 rounded-2xl mb-4 border-red-500/20">
                <h2 class="font-bold mb-2 text-lg">Database Cleanup</h2>
                <p class="text-xgray text-sm mb-4">Remove old photo records to save space.</p>
                <button onclick="cleanOldData()" id="btn-purge" class="w-full btn-danger p-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                    üóëÔ∏è Auto-Clean (> 45 Days)
                </button>
                <p id="admin-log" class="text-xs mt-3 text-xgray font-mono text-center"></p>
            </div>
            <button onclick="logout()" class="w-full glass-pill p-3 rounded-full mt-4 font-bold">Logout</button>
        </div>

        <div id="student-dashboard" class="hidden">
            <div class="glass-panel rounded-3xl p-6 mb-4 flex items-center justify-between">
                <div>
                    <p class="text-xs text-xgray uppercase tracking-wider font-bold">Welcome Back</p>
                    <h1 class="text-2xl font-black leading-tight" id="st-name">Student</h1>
                </div>
                <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-xl border border-white/20">üéì</div>
            </div>

            <div id="distance-radar" class="glass-panel rounded-3xl p-5 mb-4 text-center hidden border-xaccent/30">
                <p class="text-[10px] uppercase tracking-[0.2em] text-xaccent font-bold mb-2">LIVE GPS RADAR</p>
                <div class="flex items-baseline justify-center gap-1">
                    <span id="live-range-text" class="text-4xl font-black tracking-tighter">...</span>
                    <span class="text-xl font-bold text-xgray">meters</span>
                </div>
                <div class="flex items-center justify-center gap-2 mt-3">
                    <div id="radar-dot" class="w-2.5 h-2.5 rounded-full bg-gray-600"></div>
                    <p id="range-status" class="text-sm font-medium text-xgray">Acquiring signal...</p>
                </div>
            </div>

            <div class="glass-panel rounded-3xl p-6">
                <h2 class="text-lg font-bold mb-4 text-xlight">Class Status</h2>
                
                <div id="active-session-box" class="hidden">
                    <div class="bg-emerald-500/10 border border-emerald-500/30 p-5 rounded-2xl mb-5 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500 animate-pulse"></div>
                        <p class="text-emerald-400 font-black text-xl mb-1 tracking-tight" id="session-subject">...</p>
                        <p class="text-xs text-emerald-300/70 uppercase font-bold tracking-wider">Session is Live</p>
                    </div>
                    
                    <button onclick="markAttendance()" id="markBtn" class="w-full btn-primary p-4 rounded-full font-bold shadow-lg flex items-center justify-center gap-2">
                        üì∏ Verify & Mark Present
                    </button>
                </div>

                <div id="no-session-msg" class="text-center py-10 border-2 border-dashed border-white/10 rounded-2xl">
                    <p class="text-xgray font-medium">No active classes detected.</p>
                    <button onclick="checkForActiveSessions()" class="text-xaccent text-sm mt-3 font-bold hover:underline">Refresh Status</button>
                </div>
            </div>
            <button onclick="logout()" class="w-full glass-pill p-3 rounded-full mt-6 font-bold">Logout</button>
        </div>

        <div id="teacher-dashboard" class="hidden">
            <div class="glass-panel rounded-3xl p-6 mb-4 border-l-4 border-xaccent">
                <h1 class="text-2xl font-black">üë©‚Äçüè´ Teacher Portal</h1>
                <p class="text-sm text-xgray font-medium mt-1">Classroom Control Center</p>
            </div>

            <div class="glass-panel rounded-3xl p-6 mb-6">
                <h2 class="font-bold mb-4 text-lg border-b border-white/10 pb-3">‚è±Ô∏è Session Control</h2>
                
                <div id="start-controls">
                    <div class="space-y-3 mb-5">
                        <div>
                            <label class="text-xs text-xgray font-bold ml-2 uppercase">Subject</label>
                            <select id="t-subject" class="glass-input w-full p-3 rounded-xl mt-1 cursor-pointer">
                                <option class="bg-xpanel">Agadtantra</option>
                                <option class="bg-xpanel">Swasthavritta</option>
                                <option class="bg-xpanel">Samhita-II</option>
                                <option class="bg-xpanel">Rog Nidan</option>
                                <option class="bg-xpanel">Dravyaguna</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-xgray font-bold ml-2 uppercase">Duration</label>
                            <select id="t-duration" class="glass-input w-full p-3 rounded-xl mt-1 cursor-pointer">
                                <option class="bg-xpanel" value="5">5 Minutes</option>
                                <option class="bg-xpanel" value="10">10 Minutes</option>
                                <option class="bg-xpanel" value="60">1 Hour</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="createSession()" class="w-full btn-primary p-3 rounded-full font-bold">
                        Start Class üöÄ
                    </button>
                </div>

                <div id="cancel-controls" class="hidden">
                    <div class="bg-emerald-500/10 border border-emerald-500/30 p-4 rounded-2xl mb-4 text-center">
                        <p class="font-black text-emerald-400 text-lg">‚úÖ Session is Live</p>
                        <p class="text-xs text-emerald-300/70">Accepting attendance...</p>
                    </div>
                    <button onclick="cancelSession()" class="w-full btn-danger p-3 rounded-full font-bold flex items-center justify-center gap-2">
                        ‚õî End Session Instantly
                    </button>
                </div>
            </div>

            <div class="glass-panel rounded-3xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-bold text-lg">üìÑ Records Book</h2>
                </div>
                
                <div class="flex gap-2 mb-5 overflow-x-auto pb-2 no-scrollbar">
                    <button onclick="filterHistory('today')" class="glass-pill px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition active:scale-95">Today</button>
                    <button onclick="filterHistory('week')" class="glass-pill px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition active:scale-95">This Week</button>
                    <button onclick="filterHistory('month')" class="glass-pill px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition active:scale-95">This Month</button>
                    <button onclick="loadHistory()" class="glass-pill px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition active:scale-95 bg-white/10">All</button>
                </div>
                
                <div id="history-list" class="space-y-3 max-h-72 overflow-y-auto pr-1">
                    <p class="text-center text-xgray text-sm py-6">Select a filter above to view records.</p>
                </div>
            </div>

            <div id="report-view" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-end sm:items-center justify-center sm:p-4">
                <div class="glass-panel w-full max-w-lg rounded-t-3xl sm:rounded-3xl overflow-hidden shadow-2xl border-t border-white/20 sm:border">
                    <div class="p-5 border-b border-white/10 flex justify-between items-center">
                        <h3 class="font-black text-xl text-white" id="report-title">Attendance List</h3>
                        <button onclick="closeReport()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 transition">‚úï</button>
                    </div>
                    <div class="max-h-[70vh] overflow-y-auto p-2">
                        <table class="w-full text-sm text-left text-xgray">
                            <thead class="text-xs text-white uppercase font-bold border-b border-white/10">
                                <tr>
                                    <th class="px-4 py-3">Photo</th>
                                    <th class="px-4 py-3">Student Name</th>
                                    <th class="px-4 py-3 text-right">Time</th>
                                </tr>
                            </thead>
                            <tbody id="report-body" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <button onclick="logout()" class="w-full glass-pill p-3 rounded-full mt-6 font-bold">Logout</button>
        </div>

    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="user" class="hidden" onchange="processPhoto()">
    <canvas id="compressor" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // GLOBAL VARS
        let auth, db, currentUserName = "";
        window.activeSessionId = null;
        let watchId = null; 

        // --- üîë YOUR FIREBASE KEYS ARE HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnv-g-85KNpSmYG0ZN_tfHLR4DsXpDttc",
            authDomain: "attendance-gac-ngp.firebaseapp.com",
            projectId: "attendance-gac-ngp",
            storageBucket: "attendance-gac-ngp.firebasestorage.app",
            messagingSenderId: "772470800474",
            appId: "1:772470800474:web:5bcf5808a57995a8991863"
        };

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error(e); }

        // --- AUTH ---
        window.login = () => {
            const e = document.getElementById("email").value;
            const p = document.getElementById("password").value;
            const btn = document.getElementById("loginBtn");
            const originalText = btn.innerText;
            btn.innerText = "Verifying...";
            btn.disabled = true;
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                alert(err.message);
                btn.innerText = originalText;
                btn.disabled = false;
            });
        };
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    currentUserName = data.name || "Student";
                    document.getElementById("auth-screen").classList.add("hidden");
                    
                    if(data.role === "student") {
                        document.getElementById("student-dashboard").classList.remove("hidden");
                        document.getElementById("st-name").innerText = currentUserName;
                        checkForActiveSessions();
                        startLiveRangeTeller(); 
                    } else if (data.role === "teacher") {
                        document.getElementById("teacher-dashboard").classList.remove("hidden");
                        loadHistory(); 
                    } else if (data.role === "admin") {
                        document.getElementById("admin-dashboard").classList.remove("hidden");
                    }
                }
            }
        });

        // --- üì° LIVE RANGE TELLER (UPDATED UI) ---
        function startLiveRangeTeller() {
            if (navigator.geolocation) {
                document.getElementById("distance-radar").classList.remove("hidden");
                
                watchId = navigator.geolocation.watchPosition((pos) => {
                    const collegeLat = 21.126222; 
                    const collegeLng = 79.115222;
                    const d = getDistanceFromLatLonInM(pos.coords.latitude, pos.coords.longitude, collegeLat, collegeLng);
                    
                    const distText = Math.round(d);
                    const rangeEl = document.getElementById("live-range-text");
                    const dot = document.getElementById("radar-dot");
                    const status = document.getElementById("range-status");

                    rangeEl.innerText = distText;

                    if (d < 50) {
                        // INSIDE RANGE (Green/Accent)
                        rangeEl.style.color = "#4ade80";
                        dot.className = "w-2.5 h-2.5 rounded-full bg-green-500 animate-ping";
                        status.innerText = "‚úÖ Ready to mark attendance";
                        status.style.color = "#4ade80";
                    } else {
                        // OUTSIDE RANGE (Gray/Red)
                        rangeEl.style.color = "#eff3f4";
                        dot.className = "w-2.5 h-2.5 rounded-full bg-red-500";
                        status.innerText = `‚ùå Move ${Math.round(d - 50)}m closer to department`;
                        status.style.color = "#71767b";
                    }

                }, (err) => { console.log("GPS Error"); }, { enableHighAccuracy: true, maximumAge: 10000 });
            }
        }

        // --- STUDENT ATTENDANCE ---
        window.markAttendance = () => {
             if (navigator.geolocation) {
                const btn = document.getElementById("markBtn");
                btn.innerText = "üìç Verifying Exact Location...";
                btn.disabled = true;
                navigator.geolocation.getCurrentPosition((pos) => {
                    const collegeLat = 21.126222; 
                    const collegeLng = 79.115222;
                    const d = getDistanceFromLatLonInM(pos.coords.latitude, pos.coords.longitude, collegeLat, collegeLng);
                    
                    if (d < 50) { 
                        document.getElementById("cameraInput").click();
                        btn.innerText = "üì∏ Opening Camera...";
                    } else { 
                        alert(`‚ùå Access Denied.\n\nYou are ${Math.round(d)}m away. Limit is 50m.`);
                        btn.innerText = "üì∏ Verify & Mark Present";
                        btn.disabled = false;
                    }
                }, (err) => { alert("GPS Error: " + err.message); btn.disabled = false; btn.innerText = "Retry"; }, {enableHighAccuracy:true});
            } else { alert("GPS not supported"); }
        };

        window.processPhoto = () => {
            const file = document.getElementById("cameraInput").files[0];
            if (!file) return;
            // Show loading state on button
            document.getElementById("markBtn").innerText = "‚è≥ Compressing & Submitting...";
            
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.getElementById("compressor");
                    const ctx = canvas.getContext("2d");
                    const MAX_WIDTH = 300; 
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    submitToDB(canvas.toDataURL("image/jpeg", 0.5));
                };
            };
        };

        async function submitToDB(photoBase64) {
             await addDoc(collection(db, "submissions"), {
                studentId: auth.currentUser.uid,
                studentName: currentUserName,
                sessionId: window.activeSessionId,
                photoBase64: photoBase64,
                timestamp: new Date(),
                status: "Present"
            });
            // Success feedback without reload for smoother feel
            const btn = document.getElementById("markBtn");
            btn.innerText = "‚úÖ Attendance Marked!";
            btn.classList.remove("bg-white", "text-black");
            btn.classList.add("bg-green-500", "text-white");
            setTimeout(() => location.reload(), 1500);
        }

        // --- TEACHER LOGIC ---
        window.createSession = async () => {
            const subject = document.getElementById("t-subject").value;
            const duration = parseInt(document.getElementById("t-duration").value);
            const endTime = new Date();
            endTime.setMinutes(endTime.getMinutes() + duration);

            const docRef = await addDoc(collection(db, "sessions"), {
                teacherId: auth.currentUser.uid,
                subject: subject,
                startTime: new Date(),
                endTime: endTime,
                isActive: true
            });
            window.currentSessionId = docRef.id;
            document.getElementById("start-controls").classList.add("hidden");
            document.getElementById("cancel-controls").classList.remove("hidden");
        };

        window.cancelSession = async () => {
            if(confirm("End this session immediately?")) {
                if(window.currentSessionId) {
                    await deleteDoc(doc(db, "sessions", window.currentSessionId));
                    document.getElementById("start-controls").classList.remove("hidden");
                    document.getElementById("cancel-controls").classList.add("hidden");
                }
            }
        };

        // --- SYSTEMATIC RECORDS (X Style Update) ---
        window.filterHistory = async (filterType) => {
            const list = document.getElementById("history-list");
            list.innerHTML = `<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>`;
            
            const q = query(collection(db, "sessions"), where("teacherId", "==", auth.currentUser.uid));
            const snapshot = await getDocs(q);
            
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            let records = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                const sDate = data.startTime.toDate();
                data.id = doc.id;
                if (filterType === 'today' && sDate >= startOfDay) records.push(data);
                else if (filterType === 'week' && sDate >= startOfWeek) records.push(data);
                else if (filterType === 'month' && sDate >= startOfMonth) records.push(data);
                else if (!filterType) records.push(data);
            });

            records.sort((a, b) => b.startTime.toDate() - a.startTime.toDate());

            list.innerHTML = "";
            if(records.length === 0) {
                list.innerHTML = `<p class="text-center text-xgray text-sm py-6 font-medium">No records found for this period.</p>`;
                return;
            }

            records.forEach(data => {
                const dateObj = data.startTime.toDate();
                const dateStr = dateObj.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
                const timeStr = dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                const div = document.createElement("div");
                // X style list item
                div.className = "glass-input p-4 rounded-2xl cursor-pointer transition hover:bg-white/5 flex justify-between items-center active:scale-[0.98]";
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="h-10 w-10 rounded-full bg-xaccent/20 flex items-center justify-center text-xaccent">üìö</div>
                        <div>
                            <p class="font-black text-base text-white leading-none">${data.subject}</p>
                            <p class="text-xs text-xgray mt-1 font-medium">${dateStr} ‚Ä¢ ${timeStr}</p>
                        </div>
                    </div>
                    <span class="text-xgray">‚Üí</span>
                `;
                div.onclick = () => showReport(data.id, data.subject);
                list.appendChild(div);
            });
        };
        window.loadHistory = () => filterHistory(null);

        window.showReport = async (sessionId, subject) => {
            document.getElementById("report-view").classList.remove("hidden");
            document.getElementById("report-title").innerText = subject;
            const tbody = document.getElementById("report-body");
            tbody.innerHTML = "<tr><td colspan='3' class='text-center p-6 text-xgray'>Loading data...</td></tr>";

            const q = query(collection(db, "submissions"), where("sessionId", "==", sessionId));
            const snapshot = await getDocs(q);

            tbody.innerHTML = "";
            if(snapshot.empty) {
                tbody.innerHTML = "<tr><td colspan='3' class='p-8 text-center text-xgray font-medium'>No students attended this class.</td></tr>";
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const time = data.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const row = `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition">
                        <td class="px-4 py-3">
                            <img src="${data.photoBase64}" class="w-10 h-10 rounded-full border-2 border-xpanel object-cover" onclick="window.open(this.src)">
                        </td>
                        <td class="px-4 py-3 font-bold text-white">${data.studentName || "Student"}</td>
                        <td class="px-4 py-3 text-right text-xgray font-mono text-xs">${time}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };
        window.closeReport = () => document.getElementById("report-view").classList.add("hidden");

        // --- UTILS ---
        window.checkForActiveSessions = async () => {
            const q = query(collection(db, "sessions"), where("isActive", "==", true));
            const snapshot = await getDocs(q);
            let found = false;
            snapshot.forEach((doc) => {
                if (new Date() < doc.data().endTime.toDate()) {
                    document.getElementById("active-session-box").classList.remove("hidden");
                    document.getElementById("no-session-msg").classList.add("hidden");
                    document.getElementById("session-subject").innerText = doc.data().subject;
                    window.activeSessionId = doc.id;
                    found = true;
                }
            });
        };
        
        window.cleanOldData = async () => {
            const btn = document.getElementById("btn-purge");
            btn.innerHTML = "Processing... ‚è≥";
            btn.disabled = true;
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - 45); 
            const q = query(collection(db, "submissions"), where("timestamp", "<", cutoff));
            const snapshot = await getDocs(q);
            snapshot.forEach(async (d) => await deleteDoc(d.ref));
            btn.innerHTML = "Done ‚úÖ";
            setTimeout(() => { btn.innerHTML = "üóëÔ∏è Auto-Clean (> 45 Days)"; btn.disabled = false; }, 2000);
        };

        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R = 6371e3; var dLat = (lat2-lat1) * Math.PI/180; var dLon = (lon2-lon1) * Math.PI/180; 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; 
        }
    </script>
</body>
</html>
