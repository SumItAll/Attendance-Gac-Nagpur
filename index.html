<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAC Debug Mode V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: sans-serif; background-color: #f3f4f6; }</style>
</head>
<body class="p-4 max-w-lg mx-auto">

    <div id="auth-screen" class="bg-white p-6 rounded-lg shadow-lg mt-10">
        <h2 class="text-2xl font-bold text-center text-red-600 mb-4">üîß DEBUG MODE V3</h2>
        
        <input type="email" id="email" placeholder="Email" class="w-full p-2 border rounded mb-2">
        <input type="password" id="password" placeholder="Password" class="w-full p-2 border rounded mb-4">
        
        <button id="loginBtn" onclick="tryLogin()" class="w-full bg-red-600 text-white p-2 rounded font-bold">Try Login</button>
        
        <div id="error-box" class="mt-4 p-2 bg-black text-green-400 font-mono text-xs rounded hidden"></div>
    </div>

    <div id="student-dashboard" class="hidden"><h1 class="text-2xl">üë®‚Äçüéì Student: <span id="st-name"></span></h1></div>
    <div id="admin-dashboard" class="hidden"><h1 class="text-2xl text-red-600">üõ°Ô∏è Admin Panel Active</h1></div>

    <script type="module">
        // 1. IMPORTS MUST BE AT THE VERY TOP
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. DEFINE GLOBAL VARIABLES
        let auth, db;

        // ---------------------------------------------------------
        // 3. PASTE YOUR KEYS CAREFULLY HERE
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBnv-g-85KNpSmYG0ZN_tfHLR4DsXpDttc",
  authDomain: "attendance-gac-ngp.firebaseapp.com",
  projectId: "attendance-gac-ngp",
  storageBucket: "attendance-gac-ngp.firebasestorage.app",
  messagingSenderId: "772470800474",
  appId: "1:772470800474:web:5bcf5808a57995a8991863"
        };
        // ---------------------------------------------------------

        // 4. INITIALIZE FIREBASE
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);      // Assign to global variable
            db = getFirestore(app);   // Assign to global variable
            console.log("Firebase initialized");
        } catch (e) {
            alert("FIREBASE CONFIG ERROR:\n" + e.message);
        }

        // 5. LOGIN FUNCTION
        window.tryLogin = () => {
            const e = document.getElementById("email").value;
            const p = document.getElementById("password").value;
            
            // Check if auth is ready
            if(!auth) { 
                alert("CRITICAL: Firebase did not load. Check your API Keys."); 
                return; 
            }
            if(!e || !p) { alert("Please enter email and password"); return; }
            
            document.getElementById("loginBtn").innerText = "Logging in...";
            
            signInWithEmailAndPassword(auth, e, p)
            .then((userCredential) => {
                alert("Login Success! Checking Database...");
            })
            .catch((error) => {
                alert("LOGIN FAILED:\n" + error.message);
                document.getElementById("loginBtn").innerText = "Try Login";
            });
        };

        // 6. LISTEN FOR LOGIN STATE
        // We wait 1 second to make sure everything is loaded
        setTimeout(() => {
            if(auth) {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const userDoc = await getDoc(doc(db, "users", user.uid));
                            if (userDoc.exists()) {
                                const data = userDoc.data();
                                alert("‚úÖ SUCCESS! Role: " + data.role);
                                
                                document.getElementById("auth-screen").classList.add("hidden");
                                if(data.role === "student") {
                                    document.getElementById("student-dashboard").classList.remove("hidden");
                                    document.getElementById("st-name").innerText = data.name;
                                } else if (data.role === "admin") {
                                    document.getElementById("admin-dashboard").classList.remove("hidden");
                                }
                            } else {
                                alert("Login worked, but User Profile is missing in 'users' collection.");
                            }
                        } catch(err) {
                            alert("DATABASE ERROR:\n" + err.message);
                        }
                    }
                });
            }
        }, 1000);
    </script>
</body>
</html>
