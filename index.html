<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAC Attendance App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: sans-serif; background-color: #f3f4f6; }</style>
</head>
<body class="p-4 max-w-lg mx-auto">

    <div id="auth-screen" class="bg-white p-6 rounded-lg shadow-lg mt-10">
        <h2 class="text-3xl font-bold text-center text-green-700 mb-2">üåø GAC Sakkardara</h2>
        <p class="text-center text-gray-500 mb-6">Attendance System</p>

        <input type="email" id="email" placeholder="Email" class="w-full p-3 border rounded mb-3">
        <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded mb-4">
        
        <button id="loginBtn" onclick="login()" class="w-full bg-green-600 text-white p-3 rounded font-bold hover:bg-green-700">Login</button>
        <p id="status-msg" class="text-center mt-4 text-sm text-red-500"></p>
    </div>

    <div id="admin-dashboard" class="hidden">
        <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-red-500">
            <h1 class="text-xl font-bold text-red-700">üõ°Ô∏è Admin Panel</h1>
            <p class="text-sm text-gray-500">Welcome, <span id="admin-name"></span></p>
        </div>

        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="font-bold mb-2">Database Maintenance</h2>
            <p class="text-sm text-gray-600 mb-4">Delete old attendance photos to keep the app free forever.</p>
            <button onclick="cleanOldData()" id="btn-purge" class="w-full bg-red-100 text-red-700 border border-red-200 p-3 rounded font-bold">
                üóëÔ∏è Clean Data (> 45 Days)
            </button>
            <p id="admin-log" class="text-xs mt-3 text-gray-500 font-mono"></p>
        </div>
        <button onclick="logout()" class="mt-6 text-gray-500 w-full text-center">Logout</button>
    </div>

    <div id="student-dashboard" class="hidden">
        <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-green-500">
            <h1 class="text-xl font-bold">üë®‚Äçüéì Student Profile</h1>
            <p class="text-gray-600">Name: <span id="st-name" class="font-bold"></span></p>
        </div>

        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">Mark Attendance</h2>
            
            <div id="active-session-box" class="p-4 bg-yellow-50 border border-yellow-200 rounded hidden">
                <div class="flex items-center mb-2">
                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse mr-2"></div>
                    <p class="font-bold text-yellow-800">Class In Progress</p>
                </div>
                <p id="session-subject" class="text-lg font-bold mb-1">...</p>
                <p class="text-xs text-gray-500 mb-4">Click below to verify location & upload selfie.</p>
                <button onclick="markAttendance()" class="w-full bg-blue-600 text-white p-3 rounded font-bold shadow-lg">üì∏ Mark Present</button>
            </div>

            <div id="no-session-msg" class="text-gray-400 text-center py-8 bg-gray-50 rounded border border-dashed">
                <p>No active classes right now.</p>
                <button onclick="checkForActiveSessions()" class="text-blue-500 text-sm mt-2 underline">Refresh</button>
            </div>
        </div>
        <button onclick="logout()" class="mt-6 text-gray-500 w-full text-center">Logout</button>
    </div>

    <div id="teacher-dashboard" class="hidden">
        <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-blue-500">
            <h1 class="text-xl font-bold text-blue-700">üë©‚Äçüè´ Teacher Panel</h1>
            <p class="text-sm text-gray-500">Create Attendance Window</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
            <label class="block mb-1 font-bold text-sm">Select Subject</label>
            <select id="t-subject" class="w-full p-3 border rounded mb-4 bg-gray-50">
                <option>Agadtantra</option>
                <option>Swasthavritta</option>
                <option>Samhita-II</option>
                <option>Rog Nidan</option>
                <option>Dravyaguna</option>
                <option>Rasashastra</option>
            </select>
            
            <label class="block mb-1 font-bold text-sm">Duration (Minutes)</label>
            <select id="t-duration" class="w-full p-3 border rounded mb-6 bg-gray-50">
                <option value="5">5 Minutes</option>
                <option value="10">10 Minutes</option>
                <option value="60">1 Hour</option>
            </select>
            
            <button onclick="createSession()" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">Start Class</button>
        </div>
        <button onclick="logout()" class="mt-6 text-gray-500 w-full text-center">Logout</button>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="user" class="hidden" onchange="processPhoto()">
    <canvas id="compressor" class="hidden"></canvas>

    <script type="module">
        // --- 1. IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 2. GLOBAL VARIABLES ---
        let auth, db;
        window.activeSessionId = null;

        // --- 3. CONFIGURATION (PASTE KEYS HERE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnv-g-85KNpSmYG0ZN_tfHLR4DsXpDttc",
  authDomain: "attendance-gac-ngp.firebaseapp.com",
  projectId: "attendance-gac-ngp",
  storageBucket: "attendance-gac-ngp.firebasestorage.app",
  messagingSenderId: "772470800474",
  appId: "1:772470800474:web:5bcf5808a57995a8991863"
        };

        // --- 4. INITIALIZE ---
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("App Initialized");
        } catch (e) {
            alert("Error: " + e.message);
        }

        // --- 5. AUTHENTICATION ---
        window.login = () => {
            const e = document.getElementById("email").value;
            const p = document.getElementById("password").value;
            document.getElementById("loginBtn").innerText = "Checking...";
            
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                alert(err.message);
                document.getElementById("loginBtn").innerText = "Login";
            });
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    document.getElementById("auth-screen").classList.add("hidden");
                    
                    if(data.role === "student") {
                        document.getElementById("student-dashboard").classList.remove("hidden");
                        document.getElementById("st-name").innerText = data.name;
                        checkForActiveSessions(); // Auto-check for class
                    } else if (data.role === "teacher") {
                        document.getElementById("teacher-dashboard").classList.remove("hidden");
                    } else if (data.role === "admin") {
                        document.getElementById("admin-dashboard").classList.remove("hidden");
                        document.getElementById("admin-name").innerText = data.name;
                    }
                } else {
                    alert("User has no profile in Database!");
                }
            }
        });

        // --- 6. STUDENT LOGIC (Geo + Camera) ---
        window.markAttendance = () => {
             if (navigator.geolocation) {
                document.getElementById("active-session-box").classList.add("opacity-50");
                navigator.geolocation.getCurrentPosition((pos) => {
                    // COLLEGE COORDINATES (Sakkardara)
                    const collegeLat = 21.1300; 
                    const collegeLng = 79.1100;
                    
                    const d = getDistanceFromLatLonInM(pos.coords.latitude, pos.coords.longitude, collegeLat, collegeLng);
                    
                    // !!! TEST MODE: 2000000 meters range (Global). 
                    // !!! CHANGE TO 200 FOR REAL COLLEGE USE.
                    if (d < 2000000) { 
                        document.getElementById("cameraInput").click(); // Open Camera
                    } else { 
                        alert("‚ùå You are " + Math.round(d) + "m away from college. Attendance Denied."); 
                        document.getElementById("active-session-box").classList.remove("opacity-50");
                    }
                }, (err) => alert("GPS Error: " + err.message));
            } else { alert("GPS not supported"); }
        };

        // Compress Photo & Upload as Text
        window.processPhoto = () => {
            const file = document.getElementById("cameraInput").files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.getElementById("compressor");
                    const ctx = canvas.getContext("2d");
                    const MAX_WIDTH = 400; // Small size for free DB
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const dataUrl = canvas.toDataURL("image/jpeg", 0.5);
                    submitToDB(dataUrl);
                };
            };
        };

        async function submitToDB(photoBase64) {
             await addDoc(collection(db, "submissions"), {
                studentId: auth.currentUser.uid,
                sessionId: window.activeSessionId,
                photoBase64: photoBase64,
                timestamp: new Date(),
                status: "Present"
            });
            alert("‚úÖ Attendance Marked Successfully!");
            location.reload(); // Refresh page
        }

        // --- 7. TEACHER LOGIC ---
        window.createSession = async () => {
            const subject = document.getElementById("t-subject").value;
            const duration = parseInt(document.getElementById("t-duration").value);
            const endTime = new Date();
            endTime.setMinutes(endTime.getMinutes() + duration);

            await addDoc(collection(db, "sessions"), {
                teacherId: auth.currentUser.uid,
                subject: subject,
                startTime: new Date(),
                endTime: endTime,
                isActive: true
            });
            alert("‚úÖ Class Started: " + subject);
        };

        // --- 8. SHARED LOGIC ---
        window.checkForActiveSessions = async () => {
            const q = query(collection(db, "sessions"), where("isActive", "==", true));
            const snapshot = await getDocs(q);
            let found = false;
            
            snapshot.forEach((doc) => {
                if (new Date() < doc.data().endTime.toDate()) {
                    document.getElementById("active-session-box").classList.remove("hidden");
                    document.getElementById("no-session-msg").classList.add("hidden");
                    document.getElementById("session-subject").innerText = doc.data().subject;
                    window.activeSessionId = doc.id;
                    found = true;
                }
            });
            
            if(!found) {
                 document.getElementById("active-session-box").classList.add("hidden");
                 document.getElementById("no-session-msg").classList.remove("hidden");
            }
        };

        window.cleanOldData = async () => {
            document.getElementById("btn-purge").innerText = "Scanning...";
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - 45); 
            const q = query(collection(db, "submissions"), where("timestamp", "<", cutoff));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) { 
                document.getElementById("admin-log").innerText = "No old data found."; 
                document.getElementById("btn-purge").innerText = "üóëÔ∏è Clean Data";
                return; 
            }
            
            let count = 0;
            for (const docSnap of snapshot.docs) { await deleteDoc(doc(db, "submissions", docSnap.id)); count++; }
            document.getElementById("admin-log").innerText = `Deleted ${count} old records.`;
            document.getElementById("btn-purge").innerText = "Done";
        };

        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R = 6371e3; var dLat = (lat2-lat1) * Math.PI/180; var dLon = (lon2-lon1) * Math.PI/180; 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; 
        }
    </script>
</body>
</html>
